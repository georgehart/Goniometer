/**************************************************************************

Title       : GONIOMETER
    
Author      : Georges Hart
Date        : november 2022

Description :
              A goniometer is a device that measures an angle or permits the rotation of an object to a definite position.
              In orthopedics, the former description applies more.
              The art and science of measuring the joint ranges in each plane of the joint are called goniometry.
              The term ‘goniometry’ has its origin from two Greek words, gonia, which means angle, and metron, which means to measure. 
              The first known use of a primitive version of the modern-day goniometer was by a Dutch physician and mathematician named 
              Gemma Frisius, who used it to calculate and record the position of celestial bodies with respect to Earth.


URL         : OLED SH1106
              library u8g2
              


Firmware    : 



  

 **************************************************************************/

#include <Adafruit_MPU6050.h>
#include <Adafruit_Sensor.h>
#include <Wire.h>

#include <U8g2lib.h>


#define knee_width 64
#define knee_height 59
static unsigned char knee[] = {
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xa0,
   0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0x7f, 0x00, 0x00, 0x00,
   0x00, 0x00, 0xe0, 0xff, 0xd0, 0x03, 0x00, 0x00, 0x00, 0x00, 0xf8, 0xff,
   0x01, 0x0e, 0x00, 0x00, 0x00, 0x00, 0xfe, 0xff, 0x03, 0x38, 0x00, 0x00,
   0x00, 0x80, 0xff, 0xff, 0x0f, 0xe0, 0x00, 0x00, 0x00, 0xc0, 0xfe, 0xff,
   0x1f, 0x80, 0x01, 0x00, 0x00, 0x60, 0xf8, 0xff, 0x3f, 0x00, 0x03, 0x00,
   0x00, 0x30, 0xf8, 0xff, 0x7f, 0x00, 0x06, 0x00, 0x00, 0x18, 0xf0, 0xff,
   0xff, 0x00, 0x0c, 0x00, 0x00, 0x0c, 0xe0, 0xff, 0xff, 0x01, 0x18, 0x00,
   0x00, 0x06, 0xe0, 0xff, 0xff, 0x01, 0x30, 0x00, 0x00, 0x03, 0xc0, 0xff,
   0xff, 0x01, 0x20, 0x00, 0x00, 0x01, 0xc0, 0xff, 0xff, 0x01, 0x60, 0x00,
   0x80, 0x01, 0x80, 0xff, 0xff, 0x31, 0xc0, 0x00, 0xc0, 0x00, 0x80, 0xff,
   0xff, 0x31, 0x80, 0x00, 0xc0, 0x00, 0x80, 0xff, 0xff, 0x70, 0x80, 0x01,
   0x40, 0x00, 0x00, 0xff, 0xff, 0x70, 0x00, 0x01, 0x60, 0x00, 0x00, 0xff,
   0x7f, 0x78, 0x00, 0x03, 0x20, 0x00, 0x00, 0xff, 0x7f, 0x78, 0x00, 0x02,
   0x30, 0x00, 0x00, 0xfe, 0x3f, 0x7c, 0x00, 0x02, 0x10, 0x00, 0x00, 0xfe,
   0x1f, 0x7c, 0x00, 0x06, 0x10, 0x00, 0x00, 0xff, 0x07, 0x7c, 0x00, 0x04,
   0x10, 0x00, 0x00, 0x7c, 0x01, 0x7c, 0x00, 0x04, 0x18, 0x00, 0x00, 0x00,
   0x00, 0x38, 0x00, 0x04, 0x10, 0x00, 0x00, 0x00, 0x00, 0x21, 0x00, 0x0c,
   0x18, 0x00, 0x00, 0xea, 0xff, 0x03, 0x00, 0x04, 0x08, 0x00, 0x00, 0xfe,
   0xff, 0x07, 0x00, 0x0c, 0x18, 0x00, 0x00, 0xff, 0xff, 0x07, 0x00, 0x04,
   0x08, 0x00, 0x00, 0xff, 0xff, 0x07, 0x00, 0x0c, 0x18, 0x00, 0x00, 0xff,
   0xff, 0x03, 0x00, 0x04, 0x10, 0x00, 0x00, 0xff, 0xff, 0x03, 0x00, 0x0c,
   0x10, 0x00, 0x00, 0xff, 0xff, 0x03, 0x00, 0x04, 0x18, 0x00, 0x00, 0xfe,
   0xff, 0x01, 0x00, 0x04, 0x10, 0x00, 0x00, 0xfc, 0xff, 0x00, 0x00, 0x06,
   0x30, 0x00, 0x80, 0xfd, 0x7f, 0x00, 0x00, 0x06, 0x30, 0x00, 0x00, 0xf9,
   0x3f, 0x00, 0x00, 0x02, 0x20, 0x00, 0x80, 0xf9, 0x3f, 0x00, 0x00, 0x02,
   0x60, 0x00, 0x80, 0xf9, 0x1f, 0x00, 0x00, 0x03, 0x40, 0x00, 0x80, 0xf9,
   0x1f, 0x00, 0x00, 0x01, 0x40, 0x00, 0x80, 0xf9, 0x0f, 0x00, 0x80, 0x01,
   0xc0, 0x00, 0x80, 0xf9, 0x0f, 0x00, 0x80, 0x00, 0x80, 0x01, 0x80, 0xf9,
   0x0f, 0x00, 0xc0, 0x00, 0x00, 0x01, 0x80, 0xf1, 0x0f, 0x00, 0x40, 0x00,
   0x00, 0x03, 0x80, 0xf9, 0x07, 0x00, 0x60, 0x00, 0x00, 0x06, 0x80, 0xf1,
   0x07, 0x00, 0x30, 0x00, 0x00, 0x04, 0x80, 0xf9, 0x07, 0x00, 0x18, 0x00,
   0x00, 0x1c, 0xc0, 0xf9, 0x07, 0x00, 0x0c, 0x00, 0x00, 0x10, 0x80, 0xf9,
   0x07, 0x00, 0x06, 0x00, 0x00, 0x70, 0xc0, 0xf8, 0x03, 0x00, 0x03, 0x00,
   0x00, 0xc0, 0xc0, 0xf9, 0x03, 0x80, 0x01, 0x00, 0x00, 0x80, 0xc1, 0xf8,
   0x03, 0xe0, 0x00, 0x00, 0x00, 0x00, 0xc7, 0xf9, 0x03, 0x30, 0x00, 0x00,
   0x00, 0x00, 0xdc, 0xf8, 0x03, 0x1e, 0x00, 0x00, 0x00, 0x00, 0xf0, 0xfd,
   0x83, 0x07, 0x00, 0x00, 0x00, 0x00, 0x80, 0xff, 0xff, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0xf8, 0x1b, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00 
};
#define heldb_width 126
#define heldb_height 62

static unsigned char heldb[] = {
   0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xfe, 0x00, 0x00, 0x80, 0x7f,
   0xfc, 0x01, 0x00, 0x00, 0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xfe,
   0x00, 0x00, 0x80, 0x7f, 0xfc, 0x01, 0x00, 0x00, 0x07, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0xfe, 0x00, 0x00, 0x80, 0x7f, 0xfc, 0x01, 0x00, 0x00,
   0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xfe, 0x00, 0x00, 0x80, 0x7f,
   0xfc, 0x01, 0x00, 0x00, 0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xfe,
   0x00, 0x00, 0x80, 0x7f, 0xfc, 0x01, 0x00, 0x00, 0x07, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0xfe, 0x00, 0x00, 0x80, 0x7f, 0xfc, 0x01, 0x00, 0x00,
   0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xfe, 0x00, 0x00, 0x80, 0x7f,
   0xfc, 0x01, 0x00, 0x00, 0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xfe,
   0x00, 0x00, 0x80, 0x7f, 0xfc, 0x01, 0x00, 0x00, 0x07, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0xfe, 0x00, 0x00, 0x80, 0x7f, 0xfc, 0x01, 0x00, 0x00,
   0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xfe, 0x00, 0x00, 0x80, 0x7f,
   0xfc, 0x01, 0x00, 0x00, 0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xfe,
   0x00, 0x00, 0x80, 0x7f, 0xfc, 0x01, 0x00, 0x00, 0x07, 0x30, 0x00, 0x00,
   0xc0, 0x0f, 0x00, 0xfe, 0x00, 0xc0, 0x87, 0x7f, 0xfc, 0xc1, 0x07, 0x00,
   0x07, 0xff, 0x03, 0x00, 0xf8, 0x3f, 0x00, 0xfe, 0x00, 0xf8, 0xbf, 0x7f,
   0xfc, 0xf9, 0x3f, 0x00, 0xc7, 0xff, 0x07, 0x00, 0xfc, 0xff, 0x00, 0xfe,
   0x00, 0xfc, 0xff, 0x7f, 0xfc, 0xff, 0x7f, 0x00, 0xe7, 0xff, 0x0f, 0x00,
   0xfe, 0xff, 0x01, 0xfe, 0x00, 0xfe, 0xff, 0x7f, 0xfc, 0xff, 0xff, 0x00,
   0xf7, 0x83, 0x1f, 0x00, 0x1f, 0xe0, 0x03, 0xfe, 0x00, 0xff, 0xff, 0x7f,
   0xfc, 0xff, 0xff, 0x01, 0xff, 0x00, 0x3e, 0x80, 0x07, 0xc0, 0x07, 0xfe,
   0x80, 0xff, 0xff, 0x7f, 0xfc, 0xff, 0xff, 0x03, 0x7f, 0x00, 0x3c, 0xc0,
   0x03, 0x80, 0x07, 0xfe, 0xc0, 0xff, 0xff, 0x7f, 0xfc, 0xff, 0xff, 0x07,
   0x3f, 0x00, 0x78, 0xc0, 0x03, 0x00, 0x0f, 0xfe, 0xc0, 0xff, 0xff, 0x7f,
   0xfc, 0xff, 0xff, 0x07, 0x1f, 0x00, 0x70, 0xe0, 0x01, 0x00, 0x0e, 0xfe,
   0xe0, 0xff, 0xf0, 0x7f, 0xfc, 0x3f, 0xfe, 0x0f, 0x1f, 0x00, 0xf0, 0xe0,
   0x01, 0x00, 0x1e, 0xfe, 0xe0, 0x3f, 0xe0, 0x7f, 0xfc, 0x0f, 0xf8, 0x0f,
   0x0f, 0x00, 0xf0, 0xe0, 0x00, 0x00, 0x1c, 0xfe, 0xf0, 0x1f, 0xc0, 0x7f,
   0xfc, 0x07, 0xf0, 0x1f, 0x0f, 0x00, 0xe0, 0xf0, 0x00, 0x00, 0x1c, 0xfe,
   0xf0, 0x1f, 0x80, 0x7f, 0xfc, 0x03, 0xe0, 0x1f, 0x0f, 0x00, 0xe0, 0x70,
   0x00, 0x00, 0x1c, 0xfe, 0xf0, 0x0f, 0x80, 0x7f, 0xfc, 0x03, 0xe0, 0x1f,
   0x0f, 0x00, 0xe0, 0x70, 0x00, 0x00, 0x3c, 0xfe, 0xf8, 0x0f, 0x00, 0x7f,
   0xfc, 0x01, 0xe0, 0x1f, 0x0f, 0x00, 0xe0, 0x70, 0x00, 0x00, 0x38, 0xfe,
   0xf8, 0x07, 0x00, 0x7f, 0xfc, 0x01, 0xc0, 0x3f, 0x07, 0x00, 0xe0, 0x70,
   0x00, 0x00, 0x38, 0xfe, 0xf8, 0x07, 0x00, 0x7f, 0xfc, 0x01, 0xc0, 0x3f,
   0x07, 0x00, 0xe0, 0xf8, 0x00, 0x00, 0x3c, 0xfe, 0xf8, 0x07, 0x00, 0x7f,
   0xfc, 0x01, 0xc0, 0x3f, 0x07, 0x00, 0xe0, 0xf8, 0xff, 0xff, 0x3f, 0xfe,
   0xf8, 0x07, 0x00, 0x7f, 0xfc, 0x01, 0xc0, 0x3f, 0x07, 0x00, 0xe0, 0xf8,
   0xff, 0xff, 0x3f, 0xfe, 0xf8, 0x07, 0x00, 0x7f, 0xfc, 0x01, 0xc0, 0x3f,
   0x07, 0x00, 0xe0, 0xf8, 0xff, 0xff, 0x3f, 0xfe, 0xf8, 0x07, 0x00, 0x7f,
   0xfc, 0x01, 0xc0, 0x3f, 0x07, 0x00, 0xe0, 0x78, 0x00, 0x00, 0x00, 0xfe,
   0xf8, 0x07, 0x00, 0x7f, 0xfc, 0x01, 0xc0, 0x3f, 0x07, 0x00, 0xe0, 0x78,
   0x00, 0x00, 0x00, 0xfe, 0xf8, 0x07, 0x00, 0x7f, 0xfc, 0x01, 0xc0, 0x3f,
   0x07, 0x00, 0xe0, 0x78, 0x00, 0x00, 0x00, 0xfe, 0xf8, 0x07, 0x00, 0x7f,
   0xfc, 0x01, 0xc0, 0x3f, 0x07, 0x00, 0xe0, 0x70, 0x00, 0x00, 0x00, 0xfe,
   0xf8, 0x07, 0x00, 0x7f, 0xfc, 0x01, 0xc0, 0x3f, 0x07, 0x00, 0xe0, 0x70,
   0x00, 0x00, 0x00, 0xfe, 0xf8, 0x07, 0x00, 0x7f, 0xfc, 0x01, 0xe0, 0x1f,
   0x07, 0x00, 0xe0, 0x70, 0x00, 0x00, 0x00, 0xfe, 0xf0, 0x0f, 0x80, 0x7f,
   0xfc, 0x03, 0xe0, 0x1f, 0x07, 0x00, 0xe0, 0xf0, 0x00, 0x00, 0x00, 0xfe,
   0xf0, 0x0f, 0x80, 0x7f, 0xfc, 0x03, 0xe0, 0x1f, 0x07, 0x00, 0xe0, 0xf0,
   0x00, 0x00, 0x00, 0xfe, 0xf0, 0x1f, 0xc0, 0x7f, 0xfc, 0x07, 0xf0, 0x1f,
   0x07, 0x00, 0xe0, 0xe1, 0x00, 0x00, 0x1c, 0xfe, 0xf0, 0x3f, 0xc0, 0x7f,
   0xfc, 0x07, 0xf8, 0x0f, 0x07, 0x00, 0xe0, 0xe1, 0x01, 0x00, 0x1e, 0xfe,
   0xe0, 0x7f, 0xf0, 0x7f, 0xfc, 0x1f, 0xfc, 0x0f, 0x07, 0x00, 0xe0, 0xe1,
   0x01, 0x00, 0x1e, 0xfe, 0xe0, 0xff, 0xff, 0x7f, 0xfc, 0xff, 0xff, 0x0f,
   0x07, 0x00, 0xe0, 0xc1, 0x03, 0x00, 0x0f, 0xfe, 0xc0, 0xff, 0xff, 0x7f,
   0xfc, 0xff, 0xff, 0x07, 0x07, 0x00, 0xe0, 0x81, 0x07, 0x80, 0x07, 0xfe,
   0x80, 0xff, 0xff, 0x7f, 0xfc, 0xff, 0xff, 0x03, 0x07, 0x00, 0xe0, 0x81,
   0x1f, 0xe0, 0x07, 0xfe, 0x80, 0xff, 0xff, 0x7f, 0xfc, 0xff, 0xff, 0x03,
   0x07, 0x00, 0xe0, 0x01, 0xff, 0xff, 0x03, 0xfe, 0x00, 0xff, 0xff, 0x7f,
   0xfc, 0xff, 0xff, 0x01, 0x07, 0x00, 0xe0, 0x01, 0xfe, 0xff, 0x01, 0xfe,
   0x00, 0xfe, 0xff, 0x7f, 0xfc, 0xff, 0xff, 0x00, 0x07, 0x00, 0xe0, 0x01,
   0xf8, 0x7f, 0x00, 0xfe, 0x00, 0xfc, 0xff, 0x7f, 0xfc, 0xff, 0x3f, 0x00,
   0x00, 0x00, 0x00, 0x00, 0xf0, 0x1f, 0x00, 0x3c, 0x00, 0xf0, 0x0f, 0x00,
   0x00, 0xf0, 0x1f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0xfe, 0x00, 0x00, 0x00, 0x07, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xfe, 0x00, 0x00, 0x00, 0x3f,
   0xf8, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xfe,
   0x00, 0x00, 0x00, 0x3f, 0xf8, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0xfe, 0x00, 0x00, 0x00, 0x3f, 0xf8, 0x01, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xfe, 0x00, 0x00, 0x00, 0x3f,
   0xf8, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xfe,
   0x00, 0x00, 0x00, 0x3f, 0xf8, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0xfe, 0x00, 0x00, 0x00, 0x3f, 0xf8, 0x01, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xfe, 0x00, 0x00, 0x00, 0x3f,
   0xf8, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xfe,
   0x00, 0x00, 0x00, 0x3f, 0xf8, 0x01, 0x00, 0x00 
};


const float RAD2DEG = 180.0f / PI;
double x_accel;     // -----------------------
double y_accel;     //  variabelen MPU6050
double head;        // -----------------------


U8G2_SH1106_128X64_NONAME_F_HW_I2C oled(U8G2_R0, /* reset=*/ U8X8_PIN_NONE);
Adafruit_MPU6050 mpu;

void setup(void) {
  Serial.begin(115200);
  // initialize! MPU6050
  if (!mpu.begin()) {
    Serial.println("Failed to find MPU6050 chip");
    while (1) {
      delay(10);
    }
  }
 
  mpu.setAccelerometerRange(MPU6050_RANGE_8_G);
  mpu.setGyroRange(MPU6050_RANGE_500_DEG);
  mpu.setFilterBandwidth(MPU6050_BAND_21_HZ);

  oled.begin();
  oled.clearBuffer();
  oled.clearDisplay();

  heldb_logo(3000);
  introScreen(5000);
  knee_logo(5000);
  oled.setFont(u8g2_font_logisoso34_tf);
 
}

void loop() {

  /* Get new sensor events with the readings */
  sensors_event_t a, g, temp;
  mpu.getEvent(&a, &g, &temp);

  x_accel=a.acceleration.x;
  y_accel=a.acceleration.y; 
  head = mpu_x(y_accel,x_accel);
  measure(head);
  delay(10);
}


void measure(float a){
    
  oled.setDrawColor(0);
  oled.drawBox(0,0,128,64);
  oled.setDrawColor(1);
  oled.drawStr(20, 45, String(a,1).c_str());
  oled.sendBuffer();
  delay(50);

}

float mpu_x(float a, float b) {
  float head = atan2(a, b)*RAD2DEG;
  return head;
}
void introScreen(int x){
  oled.clearDisplay();
  oled.drawFrame(0,0,128,64);
  oled.setFont(u8g2_font_6x10_tr);
  oled.drawStr(40,16,"TFE 2022    ");
  oled.setFont(u8g2_font_ncenB10_tr);
  oled.drawStr(4,34,"GONIOMETRIE  ");
  oled.setFont(u8g2_font_ncenB08_tr);
  oled.drawStr(3,54,"NICOLAS BERRUYER");
  oled.sendBuffer();
  delay(x);
  oled.clearBuffer();
}

void heldb_logo(int x) { 
  oled.clearBuffer(); // clear the internal memory
  oled.clearDisplay();
  oled.drawXBM(1,1,heldb_width,heldb_height,heldb);
  oled.sendBuffer();
  delay(x);
}

void knee_logo(int x) { 
  oled.clearBuffer(); // clear the internal memory
  oled.clearDisplay();
  oled.drawXBM(36,2,knee_width,knee_height,knee);
  oled.sendBuffer();
  delay(x);
}

void logo(){

}
